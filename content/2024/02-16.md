---
title: "OpenTelemetry Collectorã§åé›†ã—ãŸãƒ›ã‚¹ãƒˆã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ãƒ­ã‚°ã‚’Grafana Cloudã«é€ä¿¡ã™ã‚‹"
date: 2024-02-16T16:48:47+09:00
draft: false
tags: ["OpenTelemetry", "Observability"]
---
## ã¯ã˜ã‚ã«
ç§ã®è‡ªå®…ã«ã¯ã€å¸¸æ™‚å‹•ã„ã¦ã„ã‚‹Linux PCãŒ2å°ã‚ã‚Šã¾ã™ã€‚ãã®ä¸Šã§DNSã‚„ã‚³ãƒ³ãƒ†ãƒŠã‚’å‹•ã‹ã—ã¦éŠã‚“ã§ã„ã‚‹ã®ã§ã™ãŒã€ã¨ãã©ãã‚µãƒ¼ãƒ“ã‚¹ãŒä½¿ãˆãªããªã£ã¦ã€ãªã‚“ãªã‚‰sshã‚‚ã§ããªããªã£ã¦ã„ã¦ã€ä»•æ–¹ãªãå†èµ·å‹•ã•ã›ã‚‹ã“ã¨ãŒ**ã¾ã‚Œã«ã‚ˆãã‚ã‚Šã¾ã™ã€‚**

è‡ªåˆ†ã ã‘ãŒä½¿ã£ã¦ã„ã‚‹ã‚‚ã®ãªã®ã§ã€ãã‚Œã§ã‚‚è‰¯ã‹ã£ãŸã®ã§ã™ãŒã€åŸå› ãŒã‚ã‹ã‚‰ãªã„ã¾ã¾æ”¾ã£ã¦ãŠãã®ã‚‚æ°—æŒã¡ãŒæ‚ªããªã£ã¦ããŸã®ã§æ­¢ã¾ã‚‹ç›´å‰ã¾ã§PCãŒã©ã®ã‚ˆã†ãªçŠ¶æ…‹ã§ã‚ã£ãŸã®ã‹æŠŠæ¡ã§ãã‚‹ã‚ˆã†ã«ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å‘¨ã‚Šã‚’æ•´å‚™ã—ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚

æœ€è¿‘ã€OpenTelemetryã¨å‘¨è¾ºæŠ€è¡“ã«èˆˆå‘³ã‚’æŒã£ã¦ã„ãŸã“ã¨ã‚‚ã‚ã£ãŸã®ã§ã€OpenTelemtryã‚’ä¸­å¿ƒã«æ§‹æˆã‚’è€ƒãˆã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã§ã¯ã€OpenTelemetry Collectorã‚’ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦åˆ©ç”¨ã—ã¦ãƒ›ã‚¹ãƒˆã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ãƒ­ã‚°ã‚’åé›†ã—ã€Grafana Cloudã«é€ä¿¡ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã„ã¾ã™ã€‚

## OpenTelemetry / OpenTelemetry Collector / Grafana Cloud ã«ã¤ã„ã¦

### OpenTelemetry
ãƒ™ãƒ³ãƒ€ãƒ¼éä¾å­˜ã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§ã‚ã‚Šã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã‚’é«˜ã‚ã‚‹ãŸã‚ã®ä»•æ§˜ã‚„ãƒ„ãƒ¼ãƒ«ã‚»ãƒƒãƒˆã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

[https://opentelemetry.io/](https://opentelemetry.io/)

### OpenTelemetry Collector
ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿ã‚’OpenTelemetry Collectorã«é€ä¿¡ã™ã‚‹ã¨ã€ä»»æ„ã®ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’proxyã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

[https://opentelemetry.io/docs/collector/](https://opentelemetry.io/docs/collector/)

ä»Šå›ã¯proxyã¨ã—ã¦ã®æ©Ÿèƒ½ã¯ä½¿ã‚ãšã«ã€node_exporterã‚„Grafana Agentã®ã‚ˆã†ãªãƒ›ã‚¹ãƒˆã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ãƒ­ã‚°ã‚’åé›†ã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã—ã¦ä½¿ã£ã¦ã„ã¾ã™ã€‚

### Grafana Cloud
Grafana LabsãŒæä¾›ã—ã¦ã„ã‚‹ãƒãƒãƒ¼ã‚¸ãƒ‰Grafanaã§ã™ã€‚ç„¡æ–™æ ãŒå¤§ããã€ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®ç™»éŒ²ãªã—ã§ä½¿ãˆã‚‹ã®ã§å€‹äººåˆ©ç”¨ã«ã¯ã‚‚ã£ã¦ã“ã„ã§ã™ã€‚

[https://grafana.com/products/cloud/](https://grafana.com/products/cloud/)

## ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ãƒ­ã‚°ã‚’åé›†ã™ã‚‹ãŸã‚ã®OpenTelemetry Collectorã®è¨­å®š
OpenTelemetry Collectorã¯å—ä¿¡ã™ã‚‹ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã®æ§˜ã€…ãªãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«å¯¾å¿œã—ãŸã‚Šã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå…ˆã‚’é¸ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ãŸãã•ã‚“ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚2ã¤ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³([otelcol](https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol)ã¨[otelcol-contrib](https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib)ãŒã‚ã‚Šã¾ã™ãŒã€ã©ã¡ã‚‰ã‚‚ä»Šå›ã®ä½¿ç”¨ç”¨é€”ã§ã¯too fatã§ã™ã€‚

ãã“ã§ã€ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«[OpenTelemetry Collector builder (ocb)](https://opentelemetry.io/docs/collector/custom-collector/)ã‚’ä½¿ã£ã¦ã€å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ã¿ã§æ§‹æˆã•ã‚ŒãŸOpenTelemetry Collectorã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ocbã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ãŒã€`buider`ã¨ã„ã†ãƒã‚¤ãƒŠãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚
```
$ go install go.opentelemetry.io/collector/cmd/builder@latest

$ buider version
ocb version v0.94.1
```

`ocb`ã‚’ä½¿ã£ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†éš›ã®ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®2ç‚¹ã§ã™ã€‚

1. åé›†ã™ã‚‹ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã€åé›†ã—ãŸå¾Œã®å‡¦ç†ã€é€ã‚Šå…ˆã‚’æ±ºã‚ã‚‹
1. 1ã§æ±ºã‚ãŸå†…å®¹ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã®ãƒãƒ‹ãƒ•ã‚§ãƒˆã¨ã—ã¦æ›¸ã

### åé›†ã™ã‚‹ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã€åé›†ã—ãŸå¾Œã®å‡¦ç†ã€é€ã‚Šå…ˆã‚’æ±ºã‚ã‚‹
ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã‚‹OpenTelemetry Collectorã«ã¯æ§˜ã€…ãªã‚³ãƒ³ãƒãƒ¼ãƒˆãƒãƒ³ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨èª¬æ˜ã—ã¾ã—ãŸã€‚è¦ã™ã‚‹ã«ã€ãã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä¸­ã‹ã‚‰å¿…è¦ãªã‚‚ã®ã‚’é¸ã¶ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã ã¨ã€ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚

- ãƒ›ã‚¹ãƒˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ãƒ­ã‚°ã‚’åé›†ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ `hostmetricsreceiver` & `filelogreceiver`
- åé›†ã—ãŸãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã‚’ãƒãƒƒãƒã§é€ã‚‹ãŸã‚ã®å‡¦ç†ã‚’ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ`batchprocessor`
- Grafanaã«é€ä¿¡ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ `otlphttpexporter`

ä¸Šè¨˜ã¯ä¸Šã‹ã‚‰é †ã«ã€`Receiver`ã€`Processor`ã€`Exporter`ã¨ã„ã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«åˆ†é¡ã•ã‚Œã¾ã™ã€‚

***
> å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è©³ç´°ã«ã¤ã„ã¦ã¯ç§ã‚‚ã¡ã‚ƒã‚“ã¨èª¬æ˜ã§ãã‚‹ã»ã©ç†è§£ã—ãã‚Œã¦ã„ãªã„ã®ã§ã“ã®è¨˜äº‹ã§ã¯å‰²æ„›ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯ä»¥ä¸‹ã®Docsã‚„ãƒªãƒã‚¸ãƒˆãƒªã‚’å¾˜å¾Šã™ã‚‹ã¨é¢ç™½ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
***
- [https://opentelemetry.io/docs/collector/](https://opentelemetry.io/docs/collector/)
- [https://github.com/open-telemetry/opentelemetry-collector](https://github.com/open-telemetry/opentelemetry-collector)

### 1ã§æ±ºã‚ãŸå†…å®¹ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã®ãƒãƒ‹ãƒ•ã‚§ãƒˆã¨ã—ã¦æ›¸ã
ä¸Šè¨˜ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å«ã‚€ã‚«ã‚¹ã‚¿ãƒ OpenTelemetry Collectorã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

```yaml
# manifest.yaml

dist:
  name: custom-otelcol
  description: custom build otelcol for home server
  output_path: ./custom-otelcol
  otelcol_version: 0.94.0

extensions:
  - gomod: github.com/open-telemetry/opentelemetry-collector-contrib/extension/basicauthextension v0.94.0

exporters:
  - gomod: go.opentelemetry.io/collector/exporter/otlphttpexporter v0.94.0

processors:
  - gomod: go.opentelemetry.io/collector/processor/batchprocessor v0.94.0

receivers:
  - gomod: github.com/open-telemetry/opentelemetry-collector-contrib/receiver/hostmetricsreceiver v0.94.0
  - gomod: github.com/open-telemetry/opentelemetry-collector-contrib/receiver/filelogreceiver v0.94.0
```

å¿…è¦ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä¸¦ã¹ãŸã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªyamlã§ã™ã€‚

```
$ builder --config=manifest-example.yaml
```

ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã™ã‚‹ã¨ã€ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œã‚‰ã‚Œã¦ã„ã¦ã€ãã®ãªã‹ã«ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
```
$ ll | grep custom-otelcol
drwxr-x--- 2 kumico kumico 4096 Feb 17 04:03 custom-otelcol

$ ll custom-otelcol | grep custom-otelcol
-rwxrwxr-x 1 kumico kumico 27963392 Feb 17 04:03 custom-otelcol
```
ã“ã‚Œã§ã‚«ã‚¹ã‚¿ãƒ OpenTelemetry Collectorã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

æ¬¡ã«OpenTelemetry Collectorã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚

### OpenTelemetry Collectorã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€Receiverã€Processorã€Exporterã®ç´°ã‹ã„å‡¦ç†ã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚
```yaml
# config.yaml

extensions:
  basicauth/otlp:
    client_auth:
      username: sample_user
      password: sample_password

receivers:
  hostmetrics:
    collection_interval: 60s
    scrapers:
      cpu:
      disk:
      filesystem:
      load:
      memory:
      network:
      paging:

  filelog:
    include:
      - /var/log/syslog
      - /var/log/auth.log

processors:
  batch:
    timeout: 1m

exporters:
  otlphttp:
    auth:
      authenticator: basicauth/otlp
    endpoint: https://otlp-gateway-prod-us-east-0.grafana.net/otlp

service:
  extensions: [basicauth/otlp]
  pipelines:
    metrics:
      receivers: [hostmetrics]
      processors: [batch]
      exporters: [otlphttp]
    logs:
      receivers: [filelog]
      processors: [batch]
      exporters: [otlphttp]
```

å†…å®¹ã‚’ç°¡å˜ã«ã¾ã¨ã‚ã¾ã™ã€‚
- Receiverã®è¨­å®šã«ã¯ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å–å¾—é–“éš”ã¨ç¨®é¡ã¨ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
- Processorã«ã¯timeoutã®è¨­å®š
- Exporterã«ã¯exportå…ˆã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(ä¸Šè¨˜ã¯Grafana Cloudã®otlp endpoint)ã¨èªè¨¼æ–¹æ³•ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

æ›¸ã‘ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒã‚¤ãƒŠãƒªå®Ÿè¡Œæ™‚ã®å¼•æ•°ã«ä¸Šè¨˜ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¸¡ã›ã°ã€Grafana Cloudã«ãƒ‡ãƒ¼ã‚¿ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚
```
$ ./custom-otelcol --config=./config.yaml
```

***
> Grafana Cloudã«ã¯ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã‚’OpenTelemetry Protocol(OTLP)ã§ç›´æ¥é€ã‚‹ã“ã¨ãŒå¯èƒ½ãªOTLP Endpoint URLãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã‹ã‚‰ç¢ºèªã§ãã‚‹URLã«å¯¾ã—ã¦Basicèªè¨¼ã§é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
***

URLã®è¨­å®šæ‰‹é †ã«é–¢ã—ã¦ã¯ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

[https://grafana.com/docs/grafana-cloud/send-data/otlp/send-data-otlp/](https://grafana.com/docs/grafana-cloud/send-data/otlp/send-data-otlp/)
:::

é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚„ãƒ­ã‚°ã‚’Grafana Cloudã§ç¢ºèªã§ãã¾ã—ãŸğŸ‘€

![screenshot-logs](https://pub-41b0c551595f4718a77aa525117fc030.r2.dev/2024%2Fscreenshot-logs.png)

![screenshot-cpu-metrics](https://pub-41b0c551595f4718a77aa525117fc030.r2.dev/2024%2Fscreenshot-cpu-metrics.png)

## ãŠã‚ã‚Šã«
OpenTelemetry Collectorã§ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã‚’é€ä¿¡ã—å§‹ã‚ã¦ã‹ã‚‰2é€±é–“ã»ã©çµŒã£ã¦ã„ã¾ã™ãŒã€ã‚¨ãƒ©ãƒ¼ã§è½ã¡ã¦ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãŒé€ä¿¡ã§ããªããªã‚‹ã‚ˆã†ãªã“ã¨ã‚‚ãªãã€è‡ªå®…ã®PCä¸Šã§å‹•ãç¶šã‘ã¦ã„ã¾ã™ã€‚ãƒ™ãƒ³ãƒ€ãƒ¼ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«åŠ ãˆã¦ã€OpenTelemetry Collectorã¨ã„ã†é¸æŠè‚¢ã‚‚ååˆ†ã«å…¥ã£ã¦ãã‚‹ãªã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

## ãŠã¾ã‘ systemdã‹ã‚‰æ“ä½œã™ã‚‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
`/etc/systemd/system/`ã«ãƒ¦ãƒ‹ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«`custom-otelcol.service`ã‚’ãŠã

```
[Unit]
Description=OpenTelemetry Collector
After=network.target

[Service]
ExecStart=/usr/local/bin/custom-otelcol --config=/etc/opentelemetry-collector-custom/config.yaml
ExecStop=/bin/kill -SIGTERM ${MAINPID}
Restart=always

[Install]
WantedBy=multi-user.target
```
é©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚Œã°ã€systemdã‹ã‚‰æ“ä½œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
```
$ systemctl start custom-otelcol.service
```
